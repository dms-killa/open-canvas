FROM node:20-alpine

# Install build essentials (native deps for some LangChain packages)
RUN apk add --no-cache git python3 make g++

# Enable Corepack for Yarn 4
RUN corepack enable && corepack prepare yarn@4.9.2 --activate

WORKDIR /app

# Copy configuration files for layer caching
COPY .yarnrc.yml package.json yarn.lock ./
COPY .yarn ./.yarn

# Copy ALL workspace package.json files so Yarn can resolve the full workspace tree.
# Missing any workspace causes Yarn to fail silently and skip dependency installation.
COPY apps/agents/package.json ./apps/agents/
COPY apps/web/package.json ./apps/web/
COPY packages/shared/package.json ./packages/shared/
COPY packages/evals/package.json ./packages/evals/

# Install dependencies
RUN yarn install

# Copy the full source code
COPY . .

# langgraph.json references "env": ".env" â€” create an empty placeholder since
# .dockerignore excludes .env (secrets are injected at runtime via docker-compose).
RUN touch .env

# Build the shared package (agents depends on @opencanvas/shared)
RUN yarn workspace @opencanvas/shared build

EXPOSE 8123

# Run from the agents workspace so `yarn langgraph` resolves the script correctly.
# The script runs: langgraph dev --host 0.0.0.0 --port 8123 --config ../../langgraph.json
WORKDIR /app/apps/agents
CMD ["yarn", "langgraph"]
